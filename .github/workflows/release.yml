---
name: Release

on:
  push:
    branches:
      - main
      - release/**

jobs:
  update_action_image:
    name: Update image version in action.yml
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Required for GitVersion

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.11
        with:
          versionSpec: "5.x" # What version of Gitversion to use

      - name: Generate gitversion
        run: echo "::set-output name=version::$(dotnet-gitversion /showvariable SemVer)"
        id: gitversion

      - name: Set image version to ${{ steps.gitversion.outputs.version }} in action.yml
        uses: mikefarah/yq@v4.24.2
        with:
          cmd: yq -i '.runs.image = "docker://europe-docker.pkg.dev/nube-hub/docker-public/velo-action:${{ steps.gitversion.outputs.version }}"' action.yml

      - name: Commit action.yml
        uses: stefanzweifel/git-auto-commit-action@v4.14.0
        with:
          commit_message: Update action image to ${{ steps.gitversion.outputs.version }}

  # must run as a seperate job to checkout the commit with the updated action.yml
  create_githib_release:
    name: Create Github release
    runs-on: ubuntu-20.04
    needs:
      - update_action_image
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Required for GitVersion

      - name: Automatic release
        uses: marvinpinto/action-automatic-releases@v1.2.1
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          automatic_release_tag: v${{ steps.gitversion.outputs.version }}
          title: v${{ steps.gitversion.outputs.version }} ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false
