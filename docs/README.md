# Velo-action

This action is part of the Velo deploy tooling.

See detailes of all inputs in [action.yml](../action.yml).

## Usage

```yaml
- uses: kolonialno/velo-action@v0.4.0
  id: velo
  with:
    # Version used to generate release and tag image. If unspecified, the git short ref is used.
    # Default: 'git rev-parrse --short HEAD'
    version: ''

    # Create a release on Octopus Deploy and save artifacts in the Velo Artifacts bucket.
    # If an environment in 'deploy_to_environments' is set, and the release does not exist, one will be created.
    # Default 'False'
    create_release: ''

    # If specified trigger a deployment to the environment.
    # Can be multiple values by separating environment names by a comma. Example 'staging,prod'.
    deploy_to_environments: ''

    # If specified trigger a deploy to the spesified tenants.
    # Can be multiple values by seperating tenant names by a comma. Example 'fc:osl1,fc:rd1'.
    # Will only deploy to environments listed in the 'deploy_to_environments' variable.
    tenants: ''

    # A Google Service account key to use for authentication. This should be the JSON
    # formatted private key which can be exported from the Cloud Console.
    service_account_key: ${{ secrets.VELO_ACTION_GSA_KEY_PROD }}
```

### Create a release

```yaml
- name: Checkout
  uses: actions/checkout@v3
  with:
    fetch-depth: 0

- name: Create release
  uses: kolonialno/velo-action@v0.4.0
  with:
    create_release: 'True'
    service_account_key: ${{ secrets.VELO_ACTION_GSA_KEY_PROD }}

```

### Create a release and deploy to staging

If a release does not exist, one will be created.

```yaml
- name: Checkout
  uses: actions/checkout@v3
  with:
    fetch-depth: 0

- name: Deploy release
  uses: kolonialno/velo-action@v0.4.0
  with:
    deploy_to_environments: staging
    service_account_key: ${{ secrets.VELO_ACTION_GSA_KEY_PROD }}
```

### Auto generate version

Velo-action will automatically generate a version if the `version` input is not set.

This version is generated by running the command `git rev-parse --short HEAD`.
It will generate a [unique](https://git-scm.com/docs/git-rev-parse#Documentation/git-rev-parse.txt---shortlength) string with at least 7 characters, example `e6ec8e7`.

But for repost with many comits it may create a longer string. For this reason you must always checkout the entire repo to get consistent results.

```yaml
- name: Checkout
  uses: actions/checkout@v3
  with:
    fetch-depth: 0

- uses: kolonialno/velo-action@v0.4.0
  id: velo
  with:
    create_release: 'True'
    service_account_key: ${{ secrets.VELO_ACTION_GSA_KEY_PROD }}

- name: Print version
  run: |
    echo Version ${{ steps.velo.outputs.version }}
```

### Run with GitVersion

```yaml
- name: Checkout
  uses: actions/checkout@v3
  with:
    fetch-depth: 0  # required for gitversion

- name: Install GitVersion
  uses: gittools/actions/gitversion/setup@v0.9.11
  with:
    versionSpec: "5.x" # What version of Gitversion to use

- name: Generate gitversion
  shell: bash
  id: gitversion
  run: echo "::set-output name=version::$(dotnet-gitversion /showvariable SemVer)"

- uses: kolonialno/velo-action@v0.4.0
  id: velo
  with:
    create_release: 'True'
    version: ${{ steps.gitversion.outputs.version }}
```
